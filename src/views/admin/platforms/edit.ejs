<%- contentFor('body') %>

  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Edit Platform Item</h1>
      <a href="/admin/platforms" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
        <i class="fas fa-arrow-left mr-2"></i> Back to List
      </a>
    </div>

    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
      <div class="mb-4">
        <form action="/admin/platforms/<%= item.id %>" method="POST" enctype="multipart/form-data">
          <!-- Basic Information -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2" for="title_en">
                Title (English) <span class="text-red-500">*</span>
              </label>
              <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="title_en" name="title_en" type="text" value="<%= item.title_en %>" required>
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2" for="title_tw">
                Title (Traditional Chinese) <span class="text-red-500">*</span>
              </label>
              <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="title_tw" name="title_tw" type="text" value="<%= item.title_tw %>" required>
            </div>
          </div>

          <!-- Category and Type Selection -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2" for="categoryId">
                Category <span class="text-red-500 category-required">*</span>
              </label>
              <select
                class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="categoryId" name="categoryId" required>
                <option value="">Select a category</option>
                <% categories.forEach(function(category) { %>
                  <option value="<%= category.id %>" <%=item.categoryId===category.id ? 'selected' : '' %>>
                    <%= category.name_en %> / <%= category.name_tw %>
                  </option>
                  <% }); %>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2" for="type">
                Content Type <span class="text-red-500">*</span>
              </label>
              <select
                class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="type" name="type" required onchange="toggleContentFields()">
                <option value="plain_text" <%=item.type==='plain_text' ? 'selected' : '' %>>Plain Text</option>
                <option value="image" <%=item.type==='image' ? 'selected' : '' %>>Image with Caption</option>
                <option value="attachment_only" <%=item.type==='attachment_only' ? 'selected' : '' %>>Attachment Only
                </option>
                <option value="partners" <%=item.type==='partners' ? 'selected' : '' %>>合作伙伴</option>
              </select>
            </div>
          </div>

          <!-- Content Fields -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <div class="content-field" id="content_en_field">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="content_en">
                  Content (English) <span class="text-red-500 content-required">*</span>
                </label>
                <textarea
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  id="content_en" name="content_en" rows="5" required><%= item.content_en %></textarea>
              </div>
            </div>
            <div>
              <div class="content-field" id="content_tw_field">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="content_tw">
                  Content (Traditional Chinese) <span class="text-red-500 content-required">*</span>
                </label>
                <textarea
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  id="content_tw" name="content_tw" rows="5" required><%= item.content_tw %></textarea>
              </div>
            </div>
          </div>

          <!-- Partners Fields (only visible for partners type) -->
          <div id="partners-fields-section" class="hidden">
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
              <h3 class="text-xl font-bold mb-4 text-blue-800">供應商 (Suppliers)</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-gray-700 text-sm font-bold mb-2" for="suppliers_en">
                    Suppliers List (English)
                  </label>
                  <textarea
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    id="suppliers_en" name="suppliers_en" rows="5"><%= item.suppliers_en || '' %></textarea>
                  <p class="text-gray-600 text-xs italic mt-1">Enter one company per line</p>
                </div>
                <div>
                  <label class="block text-gray-700 text-sm font-bold mb-2" for="suppliers_tw">
                    Suppliers List (Traditional Chinese)
                  </label>
                  <textarea
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    id="suppliers_tw" name="suppliers_tw" rows="5"><%= item.suppliers_tw || '' %></textarea>
                  <p class="text-gray-600 text-xs italic mt-1">Enter one company per line</p>
                </div>
              </div>
            </div>

            <div class="bg-green-50 p-4 rounded-lg mb-6">
              <h3 class="text-xl font-bold mb-4 text-green-800">需求商 (Buyers)</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-gray-700 text-sm font-bold mb-2" for="buyers_en">
                    Buyers List (English)
                  </label>
                  <textarea
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    id="buyers_en" name="buyers_en" rows="5"><%= item.buyers_en || '' %></textarea>
                  <p class="text-gray-600 text-xs italic mt-1">Enter one company per line</p>
                </div>
                <div>
                  <label class="block text-gray-700 text-sm font-bold mb-2" for="buyers_tw">
                    Buyers List (Traditional Chinese)
                  </label>
                  <textarea
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    id="buyers_tw" name="buyers_tw" rows="5"><%= item.buyers_tw || '' %></textarea>
                  <p class="text-gray-600 text-xs italic mt-1">Enter one company per line</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Partners Sub-Type Selection (only visible for partners type) -->
          <div id="partners-subtype-section" class="mb-4 hidden">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="partners_subtype">
              Partner Type <span class="text-red-500">*</span>
            </label>
            <select
              class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              id="partners_subtype" name="partners_subtype">
              <option value="supplier" <%=item.partners_subtype==='supplier' ? 'selected' : '' %>>供應商 (Supplier)
              </option>
              <option value="buyer" <%=item.partners_subtype==='buyer' ? 'selected' : '' %>>需求商 (Buyer)</option>
            </select>
            <p class="text-gray-600 text-xs italic mt-1">Select whether these are suppliers or buyers</p>
          </div>

          <!-- Current Image -->
          <% /* Debug info for image path */ %>
            <% console.log('Image path in template:', item.imagePath); %>
              <% if (item.imagePath) { %>
                <div class="mb-4" id="current-image-section">
                  <div class="bg-gray-100 rounded p-4">
                    <h6 class="font-bold mb-2">Current Image</h6>
                    <div class="flex items-center">
                      <img src="<%= item.imagePath %>" alt="Current image"
                        class="h-24 w-auto object-contain mr-4 border rounded">
                      <div class="flex items-center">
                        <input type="checkbox" id="removeImage" name="removeImage" value="true" class="mr-2">
                        <label for="removeImage">Remove this image</label>
                      </div>
                    </div>
                  </div>
                </div>
                <% } %>

                  <!-- Image Upload -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="block text-gray-700 text-sm font-bold mb-2" for="image">
                        <%= item.imagePath ? 'Replace Image' : 'Image' %>
                      </label>
                      <input
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        id="image" name="image" type="file" accept="image/*">
                      <p class="text-gray-600 text-xs italic mt-1">Max size: 5MB. Supported formats: JPG, PNG, GIF, WebP
                      </p>
                    </div>
                    <div>
                      <label class="block text-gray-700 text-sm font-bold mb-2" for="url">
                        External URL
                      </label>
                      <input
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        id="url" name="url" type="url" value="<%= item.url || '' %>">
                      <p class="text-gray-600 text-xs italic mt-1">Optional: Link to external website</p>
                    </div>
                  </div>

                  <!-- Current Attachments -->
                  <% /* Debug info console.log('Item attachments in template:', item.attachments);
                    console.log('Attachments length:', item.attachments ? item.attachments.length : 0); */ %>

                    <!-- Attachment Section - More prominent for attachment_only type -->
                    <div
                      class="mb-4 <%= item.type === 'attachment_only' ? 'border-2 border-blue-300 p-4 rounded-lg' : '' %>">
                      <h3 class="text-xl font-bold mb-4 <%= item.type === 'attachment_only' ? 'text-blue-600' : '' %>">
                        <%= item.type==='attachment_only' ? 'Attachments (Required)' : 'Attachments' %>
                      </h3>

                      <!-- Current Attachments -->
                      <% if (item.attachments && item.attachments.length> 0) { %>
                        <div class="mb-4">
                          <div class="bg-gray-100 rounded p-4">
                            <h6 class="font-bold mb-2">Current Attachments</h6>
                            <div class="divide-y divide-gray-200">
                              <% item.attachments.forEach(function(attachment) { %>
                                <div class="flex justify-between items-center py-2">
                                  <div class="flex items-center">
                                    <i class="fas fa-file mr-2"></i>
                                    <%= attachment.originalName %>
                                      <span class="text-gray-500 text-sm ml-2">(<%= Math.round(attachment.size / 1024)
                                          %>
                                          KB)</span>
                                  </div>
                                  <div class="flex items-center">
                                    <input type="checkbox" name="removeAttachments" value="<%= attachment.id %>"
                                      class="mr-2">
                                    <label>Remove</label>
                                  </div>
                                </div>
                                <% }); %>
                            </div>
                          </div>
                        </div>
                        <% } else { %>
                          <div class="mb-4">
                            <p
                              class="text-gray-500 <%= item.type === 'attachment_only' ? 'text-red-500 font-bold' : '' %>">
                              <%= item.type==='attachment_only'
                                ? 'No attachments found. Please add at least one attachment.'
                                : 'No attachments found for this item.' %>
                            </p>
                          </div>
                          <% } %>

                            <!-- New Attachments -->
                            <div class="mb-4">
                              <label class="block text-gray-700 text-sm font-bold mb-2" for="attachments">
                                Add New Attachments
                                <% if (item.type==='attachment_only' ) { %>
                                  <span class="text-red-500">*</span>
                                  <% } %>
                              </label>
                              <input
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="attachments" name="attachments" type="file" multiple <% if
                                (item.type==='attachment_only' && (!item.attachments || item.attachments.length===0)) {
                                %>
                              required
                              <% } %>
                                >
                                <p class="text-gray-600 text-xs italic mt-1">
                                  Max size: 50MB per file. Supported formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT,
                                  ZIP,
                                  RAR
                                </p>
                            </div>
                    </div>

                    <!-- Additional Settings -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                      <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="order">
                          Display Order
                        </label>
                        <input
                          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                          id="order" name="order" type="number" value="<%= item.order %>">
                      </div>
                      <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="status">
                          Status <span class="text-red-500">*</span>
                        </label>
                        <select
                          class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                          id="status" name="status" required>
                          <option value="draft" <%=item.status==='draft' ? 'selected' : '' %>>Draft</option>
                          <option value="published" <%=item.status==='published' ? 'selected' : '' %>>Published
                          </option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="publishedDate">
                          Published Date <span class="text-red-500">*</span>
                        </label>
                        <input
                          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                          id="publishedDate" name="publishedDate" type="date"
                          value="<%= new Date(item.publishedDate).toISOString().split('T')[0] %>" required>
                      </div>
                    </div>

                    <div class="flex items-center justify-end">
                      <button type="reset"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">
                        Reset
                      </button>
                      <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Update Platform Item
                      </button>
                    </div>
        </form>
      </div>
    </div>
  </div>

  <%- contentFor('scripts') %>
    <script>
      function toggleContentFields() {
        const type = document.getElementById('type').value;
        const contentEnField = document.getElementById('content_en');
        const contentTwField = document.getElementById('content_tw');
        const categoryField = document.getElementById('categoryId');
        const contentRequiredMarks = document.querySelectorAll('.content-required');
        const categoryRequiredMarks = document.querySelectorAll('.category-required');
        const partnersSubtypeSection = document.getElementById('partners-subtype-section');
        const partnersFieldsSection = document.getElementById('partners-fields-section');

        // Image, URL, and attachments sections
        const currentImageSection = document.getElementById('current-image-section');
        const imageUploadSection = document.getElementById('image-upload-section');
        const urlSection = document.getElementById('url-section');
        const attachmentsSection = document.getElementById('attachments-section');

        if (type === 'attachment_only') {
          // Make content fields optional
          contentEnField.required = false;
          contentTwField.required = false;
          categoryField.required = false;

          // Hide required marks
          contentRequiredMarks.forEach(mark => mark.style.display = 'none');
          categoryRequiredMarks.forEach(mark => mark.style.display = 'none');

          // Hide partners sections
          partnersSubtypeSection.classList.add('hidden');
          partnersFieldsSection.classList.add('hidden');

          // Show image, URL, and attachments sections
          if (currentImageSection) currentImageSection.style.display = 'block';
          if (imageUploadSection) imageUploadSection.style.display = 'block';
          if (urlSection) urlSection.style.display = 'block';
          if (attachmentsSection) attachmentsSection.style.display = 'block';

          // Show content fields
          document.getElementById('content_en_field').parentNode.parentNode.style.display = 'grid';
        } else if (type === 'partners') {
          // Hide content fields
          document.getElementById('content_en_field').parentNode.parentNode.style.display = 'none';

          // Make content fields not required
          contentEnField.required = false;
          contentTwField.required = false;
          categoryField.required = true;

          // Hide required marks for content, show for category
          contentRequiredMarks.forEach(mark => mark.style.display = 'none');
          categoryRequiredMarks.forEach(mark => mark.style.display = 'inline');

          // Hide old partners sub-type section
          partnersSubtypeSection.classList.add('hidden');

          // Show partners fields section
          partnersFieldsSection.classList.remove('hidden');

          // Hide image, URL, and attachments sections
          if (currentImageSection) currentImageSection.style.display = 'none';
          if (imageUploadSection) imageUploadSection.style.display = 'none';
          if (urlSection) urlSection.style.display = 'none';
          if (attachmentsSection) attachmentsSection.style.display = 'none';
        } else {
          // Make content fields required
          contentEnField.required = true;
          contentTwField.required = true;
          categoryField.required = true;

          // Show required marks
          contentRequiredMarks.forEach(mark => mark.style.display = 'inline');
          categoryRequiredMarks.forEach(mark => mark.style.display = 'inline');

          // Hide partners sections
          partnersSubtypeSection.classList.add('hidden');
          partnersFieldsSection.classList.add('hidden');

          // Show image, URL, and attachments sections
          if (currentImageSection) currentImageSection.style.display = 'block';
          if (imageUploadSection) imageUploadSection.style.display = 'block';
          if (urlSection) urlSection.style.display = 'block';
          if (attachmentsSection) attachmentsSection.style.display = 'block';

          // Show content fields
          document.getElementById('content_en_field').parentNode.parentNode.style.display = 'grid';

          // Reset labels to default
          document.querySelector('label[for="content_en"]').innerHTML =
            'Content (English) <span class="text-red-500 content-required">*</span>';
          document.querySelector('label[for="content_tw"]').innerHTML =
            'Content (Traditional Chinese) <span class="text-red-500 content-required">*</span>';
        }
      }

      // Set initial state
      document.addEventListener('DOMContentLoaded', function () {
        // Add IDs to sections for easier toggling
        const imageUploadRow = document.querySelector('input[name="image"]').closest('.grid');
        imageUploadRow.id = 'image-upload-section';

        const urlField = document.querySelector('input[name="url"]');
        if (urlField) {
          urlField.closest('div').id = 'url-section';
        }

        // Find attachments section
        const attachmentsHeadings = document.querySelectorAll('h3');
        let attachmentsSection = null;

        for (const heading of attachmentsHeadings) {
          if (heading.textContent.includes('Attachments')) {
            attachmentsSection = heading.closest('.mb-4');
            break;
          }
        }

        if (!attachmentsSection) {
          attachmentsSection = document.querySelector('input[name="attachments"]');
          if (attachmentsSection) {
            attachmentsSection = attachmentsSection.closest('.mb-4');
          }
        }

        if (attachmentsSection) {
          attachmentsSection.id = 'attachments-section';
        }

        toggleContentFields();
      });
    </script>