<%- contentFor('body') %>

    <div class="container px-6 mx-auto grid">
        <h2 class="my-6 text-2xl font-semibold text-gray-700">
            Edit Page: <%= page.title %>
        </h2>

        <% if (error_msg && error_msg.length> 0) { %>
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                <p>
                    <%= error_msg %>
                </p>
            </div>
            <% } %>

                <% if (success_msg && success_msg.length> 0) { %>
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
                        <p>
                            <%= success_msg %>
                        </p>
                    </div>
                    <% } %>

                        <div class="px-4 py-3 mb-8 bg-white rounded-lg shadow-md">
                            <form action="/admin/pages/<%= page.id %>" method="POST" class="space-y-6"
                                onsubmit="return prepareFormData()">
                                <div class="space-y-4">
                                    <!-- Title -->
                                    <div>
                                        <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                                        <input type="text" name="title" id="title" required value="<%= page.title %>"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>

                                    <!-- Category -->
                                    <div>
                                        <label for="categoryId"
                                            class="block text-sm font-medium text-gray-700">Category</label>
                                        <select name="categoryId" id="categoryId" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <% categories.forEach(function(category) { %>
                                                <option value="<%= category.id %>" <%=page.categoryId===category.id
                                                    ? 'selected' : '' %>>
                                                    <%= category.name %>
                                                </option>
                                                <% }); %>
                                        </select>
                                    </div>

                                    <!-- Status -->
                                    <div>
                                        <label for="status"
                                            class="block text-sm font-medium text-gray-700">Status</label>
                                        <select name="status" id="status" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <option value="draft" <%=page.status==='draft' ? 'selected' : '' %>>Draft
                                            </option>
                                            <option value="published" <%=page.status==='published' ? 'selected' : '' %>
                                                >Published</option>
                                        </select>
                                    </div>

                                    <!-- Navigation Settings -->
                                    <div>
                                        <div class="flex items-center">
                                            <input type="checkbox" name="showInNavigation" id="showInNavigation"
                                                <%=page.showInNavigation ? 'checked' : '' %>
                                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300
                                            rounded">
                                            <label for="showInNavigation" class="ml-2 block text-sm text-gray-900">
                                                Show in Navigation
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <label for="navigationOrder"
                                                class="block text-sm font-medium text-gray-700">Navigation Order</label>
                                            <input type="number" name="navigationOrder" id="navigationOrder"
                                                value="<%= page.navigationOrder || 0 %>"
                                                class="mt-1 block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        </div>
                                    </div>

                                    <!-- Content Type -->
                                    <div>
                                        <label for="contentType" class="block text-sm font-medium text-gray-700">Content
                                            Type</label>
                                        <select name="contentType" id="contentType" onchange="toggleEditor()"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <option value="quill" <%= page.contentType === 'quill' ? 'selected' : '' %>>Rich Text (Quill)</option>
                                            <option value="raw" <%= page.contentType === 'raw' ? 'selected' : '' %>>Raw HTML</option>
                                        </select>
                                    </div>

                                    <!-- Quill Editor -->
                                    <div id="quillEditor" class="<%= page.contentType === 'raw' ? 'hidden' : '' %>">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Content (Rich
                                            Text)</label>
                                        <div id="editor" style="height: 300px;"></div>
                                    </div>

                                    <!-- Raw HTML Editor -->
                                    <div id="rawEditor" class="<%= page.contentType === 'raw' ? '' : 'hidden' %>">
                                        <label for="rawContent" class="block text-sm font-medium text-gray-700">Content
                                            (Raw HTML)</label>
                                        <textarea name="rawContent" id="rawContent" rows="12"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono"><%= page.contentType === 'raw' ? page.content : '' %></textarea>
                                    </div>

                                    <!-- SEO Settings -->
                                    <div class="border-t border-gray-200 pt-4">
                                        <h3 class="text-lg font-medium text-gray-900 mb-4">SEO Settings</h3>

                                        <div class="space-y-4">
                                            <div>
                                                <label for="metaTitle"
                                                    class="block text-sm font-medium text-gray-700">Meta Title</label>
                                                <input type="text" name="metaTitle" id="metaTitle"
                                                    value="<%= page.metaTitle || '' %>"
                                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            </div>

                                            <div>
                                                <label for="metaDescription"
                                                    class="block text-sm font-medium text-gray-700">Meta
                                                    Description</label>
                                                <textarea name="metaDescription" id="metaDescription" rows="3"
                                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"><%= page.metaDescription || '' %></textarea>
                                            </div>

                                            <div>
                                                <label for="metaKeywords"
                                                    class="block text-sm font-medium text-gray-700">Meta
                                                    Keywords</label>
                                                <input type="text" name="metaKeywords" id="metaKeywords"
                                                    value="<%= page.metaKeywords || '' %>"
                                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                                    placeholder="Comma-separated keywords">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hidden Fields -->
                                    <input type="hidden" name="content" id="hiddenContent">
                                </div>

                                <!-- Form Actions -->
                                <div class="flex justify-end space-x-3">
                                    <a href="/admin/pages"
                                        class="inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                        Cancel
                                    </a>
                                    <button type="submit"
                                        class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                        Update Page
                                    </button>
                                </div>
                            </form>
                        </div>
    </div>

    <%- contentFor('head') %>
        <!-- Include Quill CSS -->
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

        <%- contentFor('scripts') %>
            <!-- Include Quill JS -->
            <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
            <script>
                // Only initialize Quill if we're not in raw mode
                var quill;
                if ('<%= page.contentType %>' !== 'raw') {
                    quill = new Quill('#editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                ['link', 'image', 'video'],
                                ['clean']
                            ]
                        }
                    });

                    // Initialize Quill with existing content
                    quill.root.innerHTML = `<%- page.content %>`;
                }

                function toggleEditor() {
                    const contentType = document.getElementById('contentType').value;
                    const quillEditor = document.getElementById('quillEditor');
                    const rawEditor = document.getElementById('rawEditor');
                    const rawContent = document.getElementById('rawContent');

                    if (contentType === 'raw') {
                        // Switch to Raw HTML
                        quillEditor.classList.add('hidden');
                        rawEditor.classList.remove('hidden');
                        
                        // If Quill is initialized and raw content is empty, copy from Quill
                        if (quill && (!rawContent.value || rawContent.value.trim() === '')) {
                            rawContent.value = quill.root.innerHTML;
                        }
                    } else {
                        // Switch to Quill
                        quillEditor.classList.remove('hidden');
                        rawEditor.classList.add('hidden');
                        
                        // Initialize Quill if it doesn't exist
                        if (!quill) {
                            quill = new Quill('#editor', {
                                theme: 'snow',
                                modules: {
                                    toolbar: [
                                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                        ['bold', 'italic', 'underline', 'strike'],
                                        [{ 'color': [] }, { 'background': [] }],
                                        [{ 'align': [] }],
                                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                        ['link', 'image', 'video'],
                                        ['clean']
                                    ]
                                }
                            });
                        }
                        
                        // If Quill is empty, copy from raw content
                        if (quill.root.innerHTML === '<p><br></p>' || !quill.root.innerHTML.trim()) {
                            quill.root.innerHTML = rawContent.value;
                        }
                    }
                }

                function prepareFormData() {
                    const contentType = document.getElementById('contentType').value;
                    const hiddenContent = document.getElementById('hiddenContent');
                    
                    if (contentType === 'raw') {
                        hiddenContent.value = document.getElementById('rawContent').value;
                    } else if (quill) {
                        hiddenContent.value = quill.root.innerHTML;
                    }
                    return true;
                }
            </script>